name: Prepare QCW Docker (from revision)
on:
  workflow_dispatch:
  workflow_call:
    outputs:
      cli_version:
        description: "Docker CLI version"
        value: ${{ jobs.build.outputs.cli_version }}
      compose_version:
        description: "Docker Compose version"
        value: ${{ jobs.build.outputs.compose_version }}
env:
  CLI_GITURL: https://github.com/docker/cli.git
  CLI_SHA: a5c7197d720daef7d8b9e6174ee78c0743cea166 # v29.2.1
  CLI_VERSION: 29.2.1
  COMPOSE_GITURL: https://github.com/docker/compose.git
  COMPOSE_SHA: c428a77111d56683b823a47590eb08de5c59a162 # v5.0.2
  COMPOSE_VERSION: 5.0.2
jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      cli_version: ${{ steps.make_versions.outputs.cli }}
      compose_version: ${{ steps.make_versions.outputs.compose }}
    steps:
      - name: ðŸ—ï¸ Install Docker Buildx
        uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f # v3.12.0
      - name: "ðŸ“ Configure checkout"
        run: git config --global core.autocrlf input
      - name: "ðŸ“ Checkout"
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 1
      - name: "ðŸ“ Fetch sources CLI"
        run: |
          mkdir docker-cli-release
          cd docker-cli-release
          git init
          git remote add origin $CLI_GITURL
          git fetch --depth 1 origin $CLI_SHA
          git checkout FETCH_HEAD
      - name: "ðŸ“ Fetch sources Compose"
        run: |
          mkdir docker-compose-release
          cd docker-compose-release
          git init
          git remote add origin $COMPOSE_GITURL
          git fetch --depth 1 origin $COMPOSE_SHA
          git checkout FETCH_HEAD
      - name: "ðŸ› ï¸ Build Docker CLI"
        working-directory: docker-cli-release
        run: |
          docker buildx bake --set binary.platform=windows/amd64
      - name: "ðŸ› ï¸ Build Docker Compose"
        working-directory: docker-compose-release
        run: |
          docker buildx bake --set binary.platform=windows/amd64
      - name: "ðŸ“¦ Pack Docker"
        run: |
          mkdir -p qcw
          cp docker-cli-release/build/docker-windows-amd64.exe qcw/docker.exe
          cp docker-compose-release/bin/build/docker-compose.exe qcw/docker-compose.exe
          cd qcw
          find . -type f \( ! -iname "*.checksums" \) -exec sha256sum -b {} \; > sha.checksums
          find . -type f \( ! -iname "*.checksums" \) -exec sha512sum -b {} \; >> sha.checksums
          cat sha.checksums
      - id: make_versions
        name: "ðŸ“Œ Export versions"
        run: |
          echo "cli=$CLI_VERSION" >> "$GITHUB_OUTPUT"
          echo "compose=$COMPOSE_VERSION" >> "$GITHUB_OUTPUT"
      - name: "ðŸš€ Upload artifact"
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: qcw-docker
          path: qcw
