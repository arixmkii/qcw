name: Prepare QCW go-wsllinks (from revision)
on:
  workflow_dispatch:
  workflow_call:
    outputs:
      gowsllinks_version:
        description: go-wsllinks version"
        value: ${{ jobs.build.outputs.gowsllinks_version }}
      bundles_version:
        description: bundles version"
        value: ${{ jobs.build.outputs.bundles_version }}
env:
  GOWSLLINKS_GITURL: https://github.com/arixmkii/go-wsllinks.git
  GOWSLLINKS_SHA: 627795837f0fecf648e4b83a67e72fb5631e58a9 # v0.0.9
  GOWSLLINKS_VERSION: 0.0.9
  BUNDLES_VERSION: 0.0.3 #increment on go-wsllinks change
jobs:
  build:
    runs-on: windows-2025
    outputs:
      gowsllinks_version: ${{ steps.make_versions.outputs.gowsllinks }}
      bundles_version: ${{ steps.make_versions.outputs.bundles }}
    steps:
      - name: "ğŸ—ï¸ Install msys2"
        uses: msys2/setup-msys2@40677d36a502eb2cf0fb808cc9dec31bf6152638 # v2.28.0
        with:
          msystem: UCRT64
          update: true
          install: >-
            git mingw-w64-ucrt-x86_64-go patch zip
      - name: "ğŸ“ Configure checkout"
        run: git config --global core.autocrlf input
      - name: "ğŸ“ Checkout"
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          fetch-depth: 1
      - name: "ğŸ“ Fetch sources"
        shell: msys2 {0}
        run: |
          mkdir go-wsllinks-release
          cd go-wsllinks-release
          git init
          git remote add origin $GOWSLLINKS_GITURL
          git fetch --depth 1 origin $GOWSLLINKS_SHA
          git checkout FETCH_HEAD
          patch --binary -l -p 1 < ../patches/go-wsllinks/0001-Create-Lima-dependency-bundles.patch
      - name: "ğŸ› ï¸ Build go-wsllinks"
        working-directory: go-wsllinks-release
        shell: msys2 {0}
        run: |
          go build -ldflags="-s -w"
          cp go-wsllinks.exe ./bundle-git
          cp go-wsllinks.exe ./bundle-wsl
      - name: "ğŸ“¦ Pack go-wsllinks"
        shell: msys2 {0}
        run: |
          mkdir -p qcw
          cp "go-wsllinks-release/go-wsllinks.exe" qcw/
          mkdir -p qcw-tmp
          cp -r "go-wsllinks-release/bundle-git" qcw-tmp/bundle-git
          cp -r "go-wsllinks-release/bundle-wsl" qcw-tmp/bundle-wsl
          pushd qcw-tmp/
          zip -9 -r ../qcw/bundles.zip .
          popd
          cd qcw
          find . -type f \( ! -iname "*.checksums" \) -exec sha256sum -b {} \; > sha.checksums
          find . -type f \( ! -iname "*.checksums" \) -exec sha512sum -b {} \; >> sha.checksums
          cat sha.checksums
      - id: make_versions
        name: "ğŸ“Œ Export versions"
        shell: msys2 {0}
        run: |
          echo "gowsllinks=$GOWSLLINKS_VERSION" >> "$GITHUB_OUTPUT"
          echo "bundles=$BUNDLES_VERSION" >> "$GITHUB_OUTPUT"
      - name: "ğŸš€ Upload artifact"
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: qcw-go-wsllinks
          path: qcw
