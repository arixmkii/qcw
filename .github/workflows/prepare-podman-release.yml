name: Prepare QCW Podman (from revision)

on: workflow_dispatch

env:
  PODMAN_GITURL: https://github.com/containers/podman.git
  PODMAN_SHA: e4719cb7cdf3ef2b0edcaa4c608117f761322aae

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: "ğŸ—ï¸ Install msys2"
        uses: msys2/setup-msys2@v2
        with:
          msystem: UCRT64
          update: true
          install: >-
            make
            git
            unzip
            base-devel
            mingw-w64-ucrt-x86_64-toolchain
            zip
            mingw-w64-ucrt-x86_64-go

      - name: "ğŸ—ï¸ Install tools"
        uses: crazy-max/ghaction-chocolatey@v3
        with:
          args: install pandoc

      - name: "ğŸ“ Configure checkout"
        run: git config --global core.autocrlf input

      - name: "ğŸ“ Checkout"
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: "ğŸ”— Link tools"
        shell: msys2 {0}
        run: |
          mkdir -p /usr/local/bin
          ln -sf "/c/Program Files/Pandoc/pandoc.exe" "/usr/local/bin/pandoc.exe"

      - name: "ğŸ“ Fetch sources"
        shell: msys2 {0}
        run: |
          mkdir podman-release
          cd podman-release
          git init
          git remote add origin $PODMAN_GITURL
          git fetch --depth 1 origin $PODMAN_SHA
          git checkout FETCH_HEAD
          patch --binary -l -p 1 < ../patches/podman/0001-Change-QEMU-netdev-to-Unix-domain-socket.patch
          patch --binary -l -p 1 < ../patches/podman/0002-Implement-QEMU-Podman-machine-on-Windows.patch

      - name: "ğŸ› ï¸ Build Podman"
        working-directory: podman-release
        shell: msys2 {0}
        run: |
          make podman-remote-release-windows_amd64.zip
          export BUILD_PODMAN_VERSION=$(test/version/version | sed 's/-.*//')
          mkdir -p contrib/win-installer/current
          cp *.zip contrib/win-installer/current/
          cd contrib/win-installer
          powershell -ExecutionPolicy Bypass -File build.ps1 $BUILD_PODMAN_VERSION dev current

      - name: "ğŸ“¦ Pack Podman"
        shell: msys2 {0}
        run: |
          mkdir -p qcw
          export BUILD_PODMAN_VERSION=$(podman-release/test/version/version | sed 's/-.*//')
          cp "podman-release/contrib/win-installer/podman-$BUILD_PODMAN_VERSION-dev-setup.exe" qcw/
          cd qcw
          find . -type f \( ! -iname "*.checksums" \) -exec sha256sum -b {} \; > sha.checksums
          find . -type f \( ! -iname "*.checksums" \) -exec sha512sum -b {} \; >> sha.checksums
          cat sha.checksums

      - name: "ğŸš€ Upload artifact"
        uses: actions/upload-artifact@v4
        with:
          name: qcw-podman
          path: qcw
