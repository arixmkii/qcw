name: Prepare QCW Podman (from revision)
on:
  workflow_dispatch:
  workflow_call:
    outputs:
      podman_version:
        description: Podman version"
        value: ${{ jobs.build.outputs.podman_version }}
env:
  PODMAN_GITURL: https://github.com/containers/podman.git
  PODMAN_SHA: f845d14e941889ba4c071f35233d09b29d363c75 # v5.7.1
  PODMAN_VERSION: 5.7.1
jobs:
  build:
    runs-on: windows-2025
    outputs:
      podman_version: ${{ steps.make_versions.outputs.podman }}
    steps:
      - name: "ğŸ—ï¸ Install msys2"
        uses: msys2/setup-msys2@4f806de0a5a7294ffabaff804b38a9b435a73bda # v2.30.0
        with:
          msystem: UCRT64
          update: true
          install: >-
            make git unzip base-devel man-db zip mingw-w64-ucrt-x86_64-go python
      - name: "ğŸ—ï¸ Install tools"
        run: |
          winget install --silent --accept-source-agreements --accept-package-agreements --disable-interactivity SoftwareFreedomConservancy.QEMU
          winget install --silent --accept-source-agreements --accept-package-agreements --disable-interactivity JohnMacFarlane.Pandoc
          dotnet tool install wix --global --version 5.0.2
      - name: "ğŸ“ Configure checkout"
        run: git config --global core.autocrlf input
      - name: "ğŸ“ Checkout"
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 1
      - name: "ğŸ”— Link tools"
        shell: msys2 {0}
        run: |
          mkdir -p /usr/local/bin
          ln -sf "$LOCALAPPDATA\\Programs\\Pandoc\\pandoc.exe" "/usr/local/bin/pandoc.exe"
          ln -sf "$USERPROFILE\\.dotnet\\tools\\wix.exe" "/usr/local/bin/wix.exe"
          ln -sf "$USERPROFILE\\.dotnet\\tools\\.store" "/usr/local/bin/.store"
      - name: "ğŸ“ Fetch sources"
        shell: msys2 {0}
        run: |
          mkdir podman-release
          cd podman-release
          git init
          git remote add origin $PODMAN_GITURL
          git fetch --depth 1 origin $PODMAN_SHA
          git checkout FETCH_HEAD
          patch --binary -l -p 1 < ../patches/podman/0001-Implement-QEMU-Podman-machine-on-Windows.patch
          patch --binary -l -p 1 < ../patches/podman/0002-Update-QEMU-CPU-baseline-to-x86-64v2.5.patch
      - name: "âš—ï¸ Prepare Test Podman"
        working-directory: podman-release
        shell: msys2 {0}
        run: |
          HELPER_BINARIES_DIR=`cygpath -w "$(pwd)/bin/windows"` make clean podman-remote win-gvproxy
      - name: "ğŸ§ª Test Podman"
        working-directory: podman-release
        shell: pwsh
        env:
          CONTAINERS_MACHINE_PROVIDER: qemu
          MACHINE_TEST_TIMEOUT: 360
          GINKGOTIMEOUT: --timeout=90m
        run: |
          $env:PATH="$env:PROGRAMFILES\QEMU;$env:PATH"
          ./winmake localmachine
      - name: "ğŸ› ï¸ Build Podman"
        working-directory: podman-release
        shell: msys2 {0}
        run: |
          make clean podman-remote-release-windows_amd64.zip
          export BUILD_PODMAN_VERSION=$(test/version/version | sed 's/-.*//')
          mkdir -p contrib/win-installer/current
          cp *.zip contrib/win-installer/current/
          cd contrib/win-installer
          powershell -ExecutionPolicy Bypass -File build.ps1 -Version $BUILD_PODMAN_VERSION -Architecture amd64 -LocalReleaseDirPath current
      - name: "ğŸ“¦ Pack Podman"
        shell: msys2 {0}
        run: |
          mkdir -p qcw
          export BUILD_PODMAN_VERSION=$(podman-release/test/version/version | sed 's/-.*//')
          cp "podman-release/contrib/win-installer/podman-$BUILD_PODMAN_VERSION.msi" qcw/
          cd qcw
          find . -type f \( ! -iname "*.checksums" \) -exec sha256sum -b {} \; > sha.checksums
          find . -type f \( ! -iname "*.checksums" \) -exec sha512sum -b {} \; >> sha.checksums
          cat sha.checksums
      - id: make_versions
        name: "ğŸ“Œ Export versions"
        shell: msys2 {0}
        run: |
          echo "podman=$PODMAN_VERSION" >> "$GITHUB_OUTPUT"
      - name: "ğŸš€ Upload artifact"
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: qcw-podman
          path: qcw
