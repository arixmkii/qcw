From 9ef3ad3959d37b6d78c51f8fe9c212ae7c6f9526 Mon Sep 17 00:00:00 2001
From: Arthur Sengileyev <arthur.sengileyev@gmail.com>
Date: Tue, 28 Jan 2025 14:55:26 +0200
Subject: [PATCH] Add Lima customizations

---
 src_x64/Makefile              | 10 +++++++---
 src_x64/cygpath               |  5 +++++
 src_x64/oobe.sh               |  8 ++++++++
 src_x64/wsl-distribution.conf |  4 ++++
 src_x64/wsl.conf              | 10 ++++++++++
 5 files changed, 34 insertions(+), 3 deletions(-)
 create mode 100755 src_x64/cygpath
 create mode 100755 src_x64/oobe.sh
 create mode 100644 src_x64/wsl-distribution.conf
 create mode 100644 src_x64/wsl.conf

diff --git a/src_x64/Makefile b/src_x64/Makefile
index ead99a0..f734975 100644
--- a/src_x64/Makefile
+++ b/src_x64/Makefile
@@ -3,7 +3,7 @@ LNCR_EXE=Alpine.exe
 
 DLR=curl
 DLR_FLAGS=-L
-BASE_URL=https://dl-cdn.alpinelinux.org/alpine/v3.20/releases/x86_64/alpine-minirootfs-3.20.3-x86_64.tar.gz
+BASE_URL=https://dl-cdn.alpinelinux.org/alpine/v3.21/releases/x86_64/alpine-minirootfs-3.21.3-x86_64.tar.gz
 ROOTFS_TARBALL_CKSM_URL=${BASE_URL}.sha512
 LNCR_ZIP_URL=https://github.com/yuk7/wsldl/releases/download/23072600/icons.zip
 LNCR_ZIP_EXE=Alpine.exe
@@ -43,9 +43,15 @@ rootfs: base.tar.gz profile
 	sudo cp -f /etc/resolv.conf rootfs/etc/resolv.conf
 	sudo cp -f profile rootfs/etc/profile
 	sudo chroot rootfs /sbin/apk update
-	sudo chroot rootfs /sbin/apk add bash
-	echo "# This file was automatically generated by WSL. To stop automatic generation of this file, remove this line." | sudo tee rootfs/etc/resolv.conf
+	sudo chroot rootfs /sbin/apk add bash openssh openssh-client-krb5 socat libdeflate-utils zstd xz bzip2
+	sudo chroot rootfs /bin/ln -s /usr/bin/libdeflate-gzip /usr/local/bin/gzip # https://github.com/microsoft/WSL/issues/12523
 	sudo rm -rf `sudo find rootfs/var/cache/apk/ -type f`
+	sudo mkdir -p rootfs/usr/lib/wsl
+	sudo cp -f oobe.sh rootfs/usr/lib/wsl/oobe.sh
+	sudo cp -f wsl.conf rootfs/etc/wsl.conf
+	sudo cp -f wsl-distribution.conf rootfs/etc/wsl-distribution.conf
+	sudo cp -f cygpath rootfs/usr/local/bin/cygpath
+	echo "# UNCONFIGURED FSTAB" | sudo tee rootfs/etc/fstab
 	sudo chmod +x rootfs
 
 base.tar.gz:
diff --git a/src_x64/cygpath b/src_x64/cygpath
new file mode 100755
index 0000000..975a36f
--- /dev/null
+++ b/src_x64/cygpath
@@ -0,0 +1,5 @@
+#!/usr/bin/env bash
+
+set -ue
+
+/bin/wslpath "$@"
diff --git a/src_x64/oobe.sh b/src_x64/oobe.sh
new file mode 100755
index 0000000..f1f14ca
--- /dev/null
+++ b/src_x64/oobe.sh
@@ -0,0 +1,8 @@
+#!/usr/bin/env bash
+
+set -ue
+
+addgroup --gid 1000 lima
+adduser -D --gecos "" --home /home/lima --ingroup lima --uid 1000 -s /bin/bash lima
+mkdir -p -m 700 /var/opt/lima
+chown lima:lima /var/opt/lima
diff --git a/src_x64/wsl-distribution.conf b/src_x64/wsl-distribution.conf
new file mode 100644
index 0000000..a0b83aa
--- /dev/null
+++ b/src_x64/wsl-distribution.conf
@@ -0,0 +1,4 @@
+[oobe]
+command = /usr/lib/wsl/oobe.sh
+defaultUid = 1000
+defaultName = lima-infra
diff --git a/src_x64/wsl.conf b/src_x64/wsl.conf
new file mode 100644
index 0000000..68c71cb
--- /dev/null
+++ b/src_x64/wsl.conf
@@ -0,0 +1,10 @@
+[boot]
+systemd = false
+
+[automount]
+enabled = true
+options = "metadata,uid=1000,gid=1000,case=off"
+
+[interop]
+enabled = true
+appendWindowsPath = true
-- 
2.43.0

