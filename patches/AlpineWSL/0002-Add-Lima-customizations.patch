From aaeefc9e90d34c8129d6f134fc0e637ae478f47f Mon Sep 17 00:00:00 2001
From: Arthur Sengileyev <arthur.sengileyev@gmail.com>
Date: Tue, 28 Jan 2025 14:55:26 +0200
Subject: [PATCH] Add Lima customizations

---
 src_x64/Makefile              |  8 +++++---
 src_x64/oobe.sh               |  8 ++++++++
 src_x64/wsl-distribution.conf |  4 ++++
 src_x64/wsl.conf              | 10 ++++++++++
 4 files changed, 27 insertions(+), 3 deletions(-)
 create mode 100755 src_x64/oobe.sh
 create mode 100644 src_x64/wsl-distribution.conf
 create mode 100644 src_x64/wsl.conf

diff --git a/src_x64/Makefile b/src_x64/Makefile
index ead99a0..d87fbc3 100644
--- a/src_x64/Makefile
+++ b/src_x64/Makefile
@@ -3,7 +3,7 @@ LNCR_EXE=Alpine.exe
 
 DLR=curl
 DLR_FLAGS=-L
-BASE_URL=https://dl-cdn.alpinelinux.org/alpine/v3.20/releases/x86_64/alpine-minirootfs-3.20.3-x86_64.tar.gz
+BASE_URL=https://dl-cdn.alpinelinux.org/alpine/v3.21/releases/x86_64/alpine-minirootfs-3.21.2-x86_64.tar.gz
 ROOTFS_TARBALL_CKSM_URL=${BASE_URL}.sha512
 LNCR_ZIP_URL=https://github.com/yuk7/wsldl/releases/download/23072600/icons.zip
 LNCR_ZIP_EXE=Alpine.exe
@@ -43,9 +43,11 @@ rootfs: base.tar.gz profile
 	sudo cp -f /etc/resolv.conf rootfs/etc/resolv.conf
 	sudo cp -f profile rootfs/etc/profile
 	sudo chroot rootfs /sbin/apk update
-	sudo chroot rootfs /sbin/apk add bash
-	echo "# This file was automatically generated by WSL. To stop automatic generation of this file, remove this line." | sudo tee rootfs/etc/resolv.conf
+	sudo chroot rootfs /sbin/apk add bash openssh openssh-client-krb5 socat
 	sudo rm -rf `sudo find rootfs/var/cache/apk/ -type f`
+	sudo cp -f oobe.sh rootfs/etc/oobe.sh
+	sudo cp -f wsl.conf rootfs/etc/wsl.conf
+	sudo cp -f wsl-distribution.conf rootfs/etc/wsl-distribution.conf
 	sudo chmod +x rootfs
 
 base.tar.gz:
diff --git a/src_x64/oobe.sh b/src_x64/oobe.sh
new file mode 100755
index 0000000..64bc8e5
--- /dev/null
+++ b/src_x64/oobe.sh
@@ -0,0 +1,8 @@
+#!/usr/bin/env bash
+
+set -ue
+
+addgroup --gid 1000 lima
+adduser -D --gecos "" --home /home/lima --ingroup lima --uid 1000 -s /bin/bash lima
+mkdir -p -m 700 /run/user/1000
+chown lima:lima /run/user/1000
diff --git a/src_x64/wsl-distribution.conf b/src_x64/wsl-distribution.conf
new file mode 100644
index 0000000..a0b83aa
--- /dev/null
+++ b/src_x64/wsl-distribution.conf
@@ -0,0 +1,4 @@
+[oobe]
+command = /etc/oobe.sh
+defaultUid = 1000
+defaultName = lima-infra
diff --git a/src_x64/wsl.conf b/src_x64/wsl.conf
new file mode 100644
index 0000000..68c71cb
--- /dev/null
+++ b/src_x64/wsl.conf
@@ -0,0 +1,10 @@
+[boot]
+systemd = false
+
+[automount]
+enabled = true
+options = "metadata,uid=1000,gid=1000,case=off"
+
+[interop]
+enabled = true
+appendWindowsPath = true
-- 
2.43.0

