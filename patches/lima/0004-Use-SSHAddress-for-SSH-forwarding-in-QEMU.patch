From ee4dc3238ce1eeb669df2741ea698d081ce9d143 Mon Sep 17 00:00:00 2001
From: Arthur Sengileyev <arthur.sengileyev@gmail.com>
Date: Sun, 16 Feb 2025 17:12:21 +0200
Subject: [PATCH 1/2] Use SSHAddress for SSH forwarding in QEMU

Signed-off-by: Arthur Sengileyev <arthur.sengileyev@gmail.com>
---
 pkg/qemu/qemu.go        | 5 +++--
 pkg/qemu/qemu_driver.go | 1 +
 2 files changed, 4 insertions(+), 2 deletions(-)

diff --git a/pkg/qemu/qemu.go b/pkg/qemu/qemu.go
index ed4390cf..5130bf3e 100644
--- a/pkg/qemu/qemu.go
+++ b/pkg/qemu/qemu.go
@@ -42,6 +42,7 @@ type Config struct {
 	InstanceDir  string
 	LimaYAML     *limayaml.LimaYAML
 	SSHLocalPort int
+	SSHAddress   string
 }
 
 // MinimumQemuVersion is the minimum supported QEMU version.
@@ -753,8 +754,8 @@ func Cmdline(ctx context.Context, cfg Config) (exe string, args []string, err er
 	// Configure default usernetwork with limayaml.MACAddress(driver.Instance.Dir) for eth0 interface
 	firstUsernetIndex := limayaml.FirstUsernetIndex(y)
 	if firstUsernetIndex == -1 {
-		args = append(args, "-netdev", fmt.Sprintf("user,id=net0,net=%s,dhcpstart=%s,hostfwd=tcp:127.0.0.1:%d-:22",
-			networks.SlirpNetwork, networks.SlirpIPAddress, cfg.SSHLocalPort))
+		args = append(args, "-netdev", fmt.Sprintf("user,id=net0,net=%s,dhcpstart=%s,hostfwd=tcp:%s:%d-:22",
+			networks.SlirpNetwork, networks.SlirpIPAddress, cfg.SSHAddress, cfg.SSHLocalPort))
 	} else {
 		qemuSock, err := usernet.Sock(y.Networks[firstUsernetIndex].Lima, usernet.QEMUSock)
 		if err != nil {
diff --git a/pkg/qemu/qemu_driver.go b/pkg/qemu/qemu_driver.go
index f33151aa..23b75488 100644
--- a/pkg/qemu/qemu_driver.go
+++ b/pkg/qemu/qemu_driver.go
@@ -72,6 +72,7 @@ func (l *LimaQemuDriver) Start(ctx context.Context) (chan error, error) {
 		InstanceDir:  l.Instance.Dir,
 		LimaYAML:     l.Instance.Config,
 		SSHLocalPort: l.SSHLocalPort,
+		SSHAddress:   l.Instance.SSHAddress,
 	}
 	qExe, qArgs, err := Cmdline(ctx, qCfg)
 	if err != nil {
-- 
2.48.1

