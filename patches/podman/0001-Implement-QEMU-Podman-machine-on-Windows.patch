From 56003919eb8a829c8f3ed41baf31f8045d3c4249 Mon Sep 17 00:00:00 2001
From: Arthur Sengileyev <arthur.sengileyev@gmail.com>
Date: Tue, 20 Feb 2024 21:52:34 +0200
Subject: [PATCH] Implement QEMU Podman machine on Windows

Signed-off-by: Arthur Sengileyev <arthur.sengileyev@gmail.com>
---
 .../win-installer/wix/podman-ui-welcome-dlg.wxs  |  3 ++-
 pkg/machine/e2e/README.md                        |  9 +++++++++
 pkg/machine/e2e/basic_test.go                    |  9 +++++++++
 pkg/machine/e2e/config_init_test.go              |  6 ++++++
 pkg/machine/e2e/config_windows_test.go           | 10 ++++++++--
 pkg/machine/e2e/init_test.go                     | 12 +++++++++++-
 pkg/machine/provider/platform_windows.go         | 12 ++++++++++++
 pkg/machine/provider/platform_windows_amd64.go   | 14 ++++++++++++++
 pkg/machine/provider/platform_windows_arm64.go   | 16 ++++++++++++++++
 9 files changed, 87 insertions(+), 4 deletions(-)
 create mode 100644 pkg/machine/provider/platform_windows_amd64.go
 create mode 100644 pkg/machine/provider/platform_windows_arm64.go

diff --git a/contrib/win-installer/wix/podman-ui-welcome-dlg.wxs b/contrib/win-installer/wix/podman-ui-welcome-dlg.wxs
index deaa305521..4aba4d3f9a 100644
--- a/contrib/win-installer/wix/podman-ui-welcome-dlg.wxs
+++ b/contrib/win-installer/wix/podman-ui-welcome-dlg.wxs
@@ -8,10 +8,11 @@
                 <Control Id="DescriptionInstall" Type="Text" X="135" Y="50" Width="220" Height="60" Transparent="yes" NoPrefix="yes" Text="!(loc.WelcomeDlgDescription)" HideCondition="WIX_UPGRADE_DETECTED" />
                 <Control Id="DescriptionUpdate" Type="Text" X="135" Y="50" Width="220" Height="60" Transparent="yes" NoPrefix="yes" Text="!(loc.WelcomeUpdateDlgDescriptionUpdate)" HideCondition="NOT WIX_UPGRADE_DETECTED" />
                 <Control Id="ProviderChoice" Type="Text" X="135" Y="115" Width="220" Height="18" Transparent="yes" NoPrefix="yes" Text="Select the Virtualization Provider for the Podman machine:" HideCondition="HIDE_PROVIDER_CHOICE" />
-                <Control Type="RadioButtonGroup" Property="MACHINE_PROVIDER" Id="MachineProviderRadioButtonGroup" Width="226" Height="30" X="135" Y="135" HideCondition="HIDE_PROVIDER_CHOICE">
+                <Control Type="RadioButtonGroup" Property="MACHINE_PROVIDER" Id="MachineProviderRadioButtonGroup" Width="226" Height="45" X="135" Y="135" HideCondition="HIDE_PROVIDER_CHOICE">
                     <RadioButtonGroup Property="MACHINE_PROVIDER">
                         <RadioButton Text="Windows Linux Subsystem (WSLv2)" Height="15" Value="wsl" Width="226" X="10" Y="0" />
                         <RadioButton Text="Windows Hyper-V" Height="15" Value="hyperv" Width="226" X="10" Y="15" />
+                        <RadioButton Text="QEMU" Height="15" Value="qemu" Width="226" X="10" Y="30" />
                     </RadioButtonGroup>
                 </Control>
                 <Control Id="Back" Type="PushButton" X="156" Y="243" Width="56" Height="17" Disabled="yes" Text="!(loc.WixUIBack)" />
diff --git a/pkg/machine/e2e/README.md b/pkg/machine/e2e/README.md
index 07deb700e1..2184274320 100644
--- a/pkg/machine/e2e/README.md
+++ b/pkg/machine/e2e/README.md
@@ -64,6 +64,15 @@ above.
 1. `$env:CONTAINERS_MACHINE_PROVIDER="wsl"`
 1. `.\winmake localmachine`
 
+### QEMU
+
+1. Install QEMU and add it to either user or sysmem PATH variable
+1. Open a powershell as a regular user
+1. `.\winmake.ps1 podman-remote && .\winmake.ps1 win-gvproxy`
+1. `$env:CONTAINERS_HELPER_BINARY_DIR="$pwd\bin\windows"`
+1. `$env:CONTAINERS_MACHINE_PROVIDER="qemu"`
+1. `.\winmake localmachine`
+
 ## MacOS
 
 Macs now support two different machine providers: `applehv` and `libkrun`. The
diff --git a/pkg/machine/e2e/basic_test.go b/pkg/machine/e2e/basic_test.go
index ac3242c06f..5dd0522848 100644
--- a/pkg/machine/e2e/basic_test.go
+++ b/pkg/machine/e2e/basic_test.go
@@ -63,6 +63,9 @@ var _ = Describe("run basic podman commands", func() {
 	})
 
 	It("Volume ops", func() {
+		if testProvider.VMType() == define.QemuVirt && runtime.GOOS == "windows" {
+			Skip("volumes are not yet supported on official QEMU builds running under Windows")
+		}
 		tDir, err := filepath.Abs(GinkgoT().TempDir())
 		Expect(err).ToNot(HaveOccurred())
 		roFile := filepath.Join(tDir, "attr-test-file")
@@ -129,6 +132,9 @@ var _ = Describe("run basic podman commands", func() {
 		// In theory this could run on MacOS too, but we know virtiofs works for that now,
 		// this is just testing linux
 		skipIfNotVmtype(define.QemuVirt, "This is just adding coverage for virtiofs on linux")
+		if testProvider.VMType() == define.QemuVirt && runtime.GOOS == "windows" {
+			Skip("volumes are not yet supported on official QEMU builds running under Windows")
+		}
 
 		tDir, err := filepath.Abs(GinkgoT().TempDir())
 		Expect(err).ToNot(HaveOccurred())
@@ -224,6 +230,9 @@ var _ = Describe("run basic podman commands", func() {
 
 	It("podman volume on non-standard path", func() {
 		skipIfWSL("Requires standard volume handling")
+		if testProvider.VMType() == define.QemuVirt && runtime.GOOS == "windows" {
+			Skip("volumes are not yet supported on official QEMU builds running under Windows")
+		}
 		dir, err := os.MkdirTemp("", "machine-volume")
 		Expect(err).ToNot(HaveOccurred())
 		defer os.RemoveAll(dir)
diff --git a/pkg/machine/e2e/config_init_test.go b/pkg/machine/e2e/config_init_test.go
index ae68d0c5fb..c2cfb5cbd3 100644
--- a/pkg/machine/e2e/config_init_test.go
+++ b/pkg/machine/e2e/config_init_test.go
@@ -2,9 +2,11 @@ package e2e_test
 
 import (
 	"fmt"
+	"runtime"
 	"strconv"
 	"strings"
 
+	"github.com/containers/podman/v6/pkg/machine/define"
 	. "github.com/onsi/ginkgo/v2"
 	. "github.com/onsi/gomega"
 	. "github.com/onsi/gomega/gexec"
@@ -59,6 +61,10 @@ func (i *initMachine) buildCmd(m *machineTestBuilder) []string {
 	for _, v := range i.volumes {
 		cmd = append(cmd, "--volume", v)
 	}
+	// Suppress default mounts for QEMU on Windows
+	if len(i.volumes) == 0 && testProvider.VMType() == define.QemuVirt && runtime.GOOS == "windows" {
+		cmd = append(cmd, "--volume", "")
+	}
 	if i.now {
 		cmd = append(cmd, "--now")
 	}
diff --git a/pkg/machine/e2e/config_windows_test.go b/pkg/machine/e2e/config_windows_test.go
index 294c989f97..74b36870c5 100644
--- a/pkg/machine/e2e/config_windows_test.go
+++ b/pkg/machine/e2e/config_windows_test.go
@@ -29,14 +29,18 @@ func initPlatform() {
 		fakeImagePath = fullFileName
 		fmt.Println("Created fake disk image: " + fakeImagePath)
 	case define.WSLVirt.String():
+	case define.QemuVirt.String():
+		fakeImagePath = os.DevNull
 	default:
 		Fail(fmt.Sprintf("unknown Windows provider: %q", testProvider.VMType().String()))
 	}
 }
 
 func cleanupPlatform() {
-	if err := os.Remove(fakeImagePath); err != nil {
-		fmt.Printf("Failed to remove %s image: %q\n", fakeImagePath, err)
+	if fakeImagePath != os.DevNull {
+		if err := os.Remove(fakeImagePath); err != nil {
+			fmt.Printf("Failed to remove %s image: %q\n", fakeImagePath, err)
+		}
 	}
 }
 
@@ -79,6 +83,8 @@ func (i *initMachine) withFakeImage(mb *machineTestBuilder) *initMachine {
 		i.image = fakeImagePath
 	case define.WSLVirt:
 		i.image = mb.imagePath
+	case define.QemuVirt:
+		i.image = fakeImagePath
 	default:
 		Fail(fmt.Sprintf("unknown Windows provider: %q", testProvider.VMType().String()))
 	}
diff --git a/pkg/machine/e2e/init_test.go b/pkg/machine/e2e/init_test.go
index f9d8a6faa2..3dbd9268ae 100644
--- a/pkg/machine/e2e/init_test.go
+++ b/pkg/machine/e2e/init_test.go
@@ -325,6 +325,9 @@ var _ = Describe("podman machine init", func() {
 
 	It("machine init with volume", func() {
 		skipIfWSL("WSL volumes are much different.  This test will not pass as is")
+		if testProvider.VMType() == define.QemuVirt && runtime.GOOS == "windows" {
+			Skip("volumes are not yet supported on official QEMU builds running under Windows")
+		}
 
 		tmpDir, err := os.MkdirTemp("", "")
 		Expect(err).ToNot(HaveOccurred())
@@ -648,7 +651,11 @@ var _ = Describe("podman machine init", func() {
 		var providerOverride string
 		switch testProvider.VMType() {
 		case define.QemuVirt, define.AppleHvVirt, define.LibKrun:
-			providerOverride = "wsl"
+			if runtime.GOOS == "windows" {
+				providerOverride = "applehv"
+			} else {
+				providerOverride = "wsl"
+			}
 		case define.WSLVirt, define.HyperVVirt:
 			providerOverride = "applehv"
 		default:
@@ -665,6 +672,9 @@ var _ = Describe("podman machine init", func() {
 	It("machine init --provider", func() {
 		skipIfVmtype(define.WSLVirt, "Skip to avoid long tests or image pulls on Windows")
 		skipIfVmtype(define.HyperVVirt, "Skip to avoid long tests or image pulls Windows")
+		if testProvider.VMType() == define.QemuVirt && runtime.GOOS == "windows" {
+			Skip("Skip to avoid long tests or image pulls Windows")
+		}
 		verify := make(map[string]string)
 
 		// Loop all providers and create a map with
diff --git a/pkg/machine/provider/platform_windows.go b/pkg/machine/provider/platform_windows.go
index 2068c54467..f13bb5f1d5 100644
--- a/pkg/machine/provider/platform_windows.go
+++ b/pkg/machine/provider/platform_windows.go
@@ -7,6 +7,7 @@ import (
 	"github.com/containers/libhvee/pkg/hypervctl"
 	"github.com/containers/podman/v6/pkg/machine/define"
 	"github.com/containers/podman/v6/pkg/machine/hyperv"
+	"github.com/containers/podman/v6/pkg/machine/qemu"
 	"github.com/containers/podman/v6/pkg/machine/vmconfigs"
 	"github.com/containers/podman/v6/pkg/machine/windows"
 	"github.com/containers/podman/v6/pkg/machine/wsl"
@@ -41,6 +42,8 @@ func Get() (vmconfigs.VMProvider, error) {
 // VMProvider
 func GetByVMType(resolvedVMType define.VMType) (vmconfigs.VMProvider, error) {
 	switch resolvedVMType {
+	case define.QemuVirt:
+		return new(qemu.QEMUStubber), nil
 	case define.WSLVirt:
 		return new(wsl.WSLStubber), nil
 	case define.HyperVVirt:
@@ -63,11 +66,18 @@ func GetAll() []vmconfigs.VMProvider {
 	if hasHyperVPermissionsFunc() {
 		providers = append(providers, new(hyperv.HyperVStubber))
 	}
+	if isQemuInstalled() {
+		providers = append(providers, new(qemu.QEMUStubber))
+	}
 	return providers
 }
 
 // SupportedProviders returns the providers that are supported on the host operating system
 func SupportedProviders() []define.VMType {
+	supported := []define.VMType{define.HyperVVirt, define.WSLVirt}
+	if isQemuInstalled() {
+		supported = append(supported, define.QemuVirt)
+	}
 	return []define.VMType{define.HyperVVirt, define.WSLVirt}
 }
 
@@ -75,6 +85,8 @@ func IsInstalled(provider define.VMType) (bool, error) {
 	switch provider {
 	case define.WSLVirt:
 		return wutil.IsWSLInstalled(), nil
+	case define.QemuVirt:
+		return isQemuInstalled(), nil
 	case define.HyperVVirt:
 		service, err := hypervctl.NewLocalHyperVService()
 		if err == nil {
diff --git a/pkg/machine/provider/platform_windows_amd64.go b/pkg/machine/provider/platform_windows_amd64.go
new file mode 100644
index 0000000000..f8de7c5f51
--- /dev/null
+++ b/pkg/machine/provider/platform_windows_amd64.go
@@ -0,0 +1,14 @@
+package provider
+
+import (
+	"github.com/containers/podman/v6/pkg/machine/qemu"
+	"github.com/containers/podman/v6/pkg/machine/vmconfigs"
+)
+
+func getQemuProvider() (vmconfigs.VMProvider, error) {
+	return new(qemu.QEMUStubber), nil
+}
+
+func isQemuInstalled() bool {
+	return true
+}
diff --git a/pkg/machine/provider/platform_windows_arm64.go b/pkg/machine/provider/platform_windows_arm64.go
new file mode 100644
index 0000000000..49e746a60f
--- /dev/null
+++ b/pkg/machine/provider/platform_windows_arm64.go
@@ -0,0 +1,16 @@
+package provider
+
+import (
+	"fmt"
+
+	"github.com/containers/podman/v6/pkg/machine/define"
+	"github.com/containers/podman/v6/pkg/machine/vmconfigs"
+)
+
+func getQemuProvider() (vmconfigs.VMProvider, error) {
+	return nil, fmt.Errorf("unsupported virtualization provider: `%s`", define.QemuVirt.String())
+}
+
+func isQemuInstalled() bool {
+	return false
+}
-- 
2.52.0

