From b2bc80512bd62c961fca19cf40693af2292cac6b Mon Sep 17 00:00:00 2001
From: Arthur Sengileyev <arthur.sengileyev@gmail.com>
Date: Fri, 4 Aug 2023 22:26:04 +0300
Subject: [PATCH 1/3] Change default QEMU CPU level to `qemu64` on Windows
 amd64

Signed-off-by: Arthur Sengileyev <arthur.sengileyev@gmail.com>
---
 pkg/machine/qemu/options_windows_amd64.go | 9 ++++-----
 1 file changed, 4 insertions(+), 5 deletions(-)

diff --git a/pkg/machine/qemu/options_windows_amd64.go b/pkg/machine/qemu/options_windows_amd64.go
index c6ea4afb5..01247cb60 100644
--- a/pkg/machine/qemu/options_windows_amd64.go
+++ b/pkg/machine/qemu/options_windows_amd64.go
@@ -5,11 +5,10 @@ var (
 )
 
 func (v *MachineVM) addArchOptions() []string {
-	// "max" level is used, because "host" is not supported with "whpx" acceleration
-	// "vmx=off" disabled nested virtualization (not needed for podman)
-	// QEMU issue to track nested virtualization: https://gitlab.com/qemu-project/qemu/-/issues/628
-	// "monitor=off" needed to support hosts, which have mwait calls disabled in BIOS/UEFI
-	opts := []string{"-machine", "q35,accel=whpx:tcg", "-cpu", "max,vmx=off,monitor=off"}
+	// "qemu64" level is used, because "host" is not supported with "whpx" acceleration.
+	// It has performance penalty, but is a stable choice for running on bare metal
+	// and inside Hyper-V machine with nested virtualization.
+	opts := []string{"-machine", "q35,accel=whpx:tcg", "-cpu", "qemu64"}
 	return opts
 }
 
-- 
2.41.0

